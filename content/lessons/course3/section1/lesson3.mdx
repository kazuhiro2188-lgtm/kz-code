# AI開発における安全なインフラ設計

## はじめに

このレッスンでは、**AI開発**において**安全なインフラ設計**を実現する方法について学びます。

## AI開発におけるセキュリティリスク

### 1. APIキーの漏洩

AI APIのキーが漏洩すると、不正利用やコストの増加につながります。

**対策:**
- 環境変数やシークレット管理サービスの使用
- キーのローテーション
- アクセス制限

### 2. プロンプトインジェクション

悪意のあるプロンプトにより、AIの動作を操作される可能性があります。

**対策:**
- プロンプトの検証
- 入力のサニタイズ
- 出力の検証

### 3. データの漏洩

学習データやユーザーデータが漏洩する可能性があります。

**対策:**
- データの暗号化
- アクセス制御
- 監査ログ

### 4. リソースの不正利用

大量のリクエストにより、リソースが枯渇する可能性があります。

**対策:**
- レート制限
- クォータ管理
- モニタリング

## 安全なインフラ設計の原則

### 1. 最小権限の原則

必要最小限の権限のみを付与します。

**実装:**
- IAMロールの適切な設定
- ネットワークセグメンテーション
- アクセス制御リスト（ACL）

### 2. 多層防御

複数の防御層を設けます。

**層:**
- ネットワーク層: ファイアウォール、VPN
- アプリケーション層: 認証・認可、入力検証
- データ層: 暗号化、バックアップ

### 3. 監視とログ

システムの動作を監視し、ログを記録します。

**監視項目:**
- API呼び出し回数
- エラー率
- レイテンシ
- コスト

### 4. インシデント対応

セキュリティインシデントに迅速に対応します。

**準備:**
- インシデント対応計画
- 自動アラート
- ロールバック手順

## 実践例

### セキュアなAI API統合

```typescript
// APIキーの管理
class SecureAIService {
  private apiKey: string;
  
  constructor() {
    // 環境変数から取得（シークレット管理サービス推奨）
    this.apiKey = process.env.AI_API_KEY || '';
    if (!this.apiKey) {
      throw new Error('AI_API_KEY is not set');
    }
  }
  
  async generate(prompt: string): Promise<string> {
    // プロンプトの検証
    if (!this.isValidPrompt(prompt)) {
      throw new Error('Invalid prompt');
    }
    
    // レート制限のチェック
    await this.checkRateLimit();
    
    // API呼び出し
    const response = await this.callAPI(prompt);
    
    // 出力の検証
    return this.validateOutput(response);
  }
  
  private isValidPrompt(prompt: string): boolean {
    // プロンプトインジェクションの検証
    const dangerousPatterns = [/system:/i, /ignore/i, /forget/i];
    return !dangerousPatterns.some(pattern => pattern.test(prompt));
  }
  
  private async checkRateLimit(): Promise<void> {
    // レート制限の実装
  }
  
  private validateOutput(output: string): string {
    // 出力の検証とサニタイズ
    return output.trim();
  }
}
```

### ネットワークセキュリティ

```
┌─────────────────┐
│  インターネット   │
└────────┬────────┘
         │
┌────────▼────────┐
│   WAF/ファイアウォール │
└────────┬────────┘
         │
┌────────▼────────┐
│   API Gateway    │
└────────┬────────┘
         │
┌────────▼────────┐
│   アプリケーション  │
└────────┬────────┘
         │
┌────────▼────────┐
│   AI Service     │
└─────────────────┘
```

## まとめ

- AI開発では、APIキーの漏洩、プロンプトインジェクション、データ漏洩などのリスクがある
- 最小権限の原則、多層防御、監視とログ、インシデント対応が重要
- 適切なセキュリティ対策により、安全なAI開発が可能になる
